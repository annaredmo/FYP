{% extends 'layout.html' %}
{% block body %}
<h1>Add Reccomended songs to your playlist from the official soundtrack</h1>
<h1> For {{session['playListName']}}</h1>

<body>

<form method="POST" class="form-register">
  <div class="form-group row">
    <div class="col-sm-6">
        <button type="button" class="btn btn-primary" onclick="officialSoundtrack()">Official Soundtrack</button>
    </div>
    <div class="col-sm-6">
      <div class="input-group">
          <input type="text" id="song-name" name="song_name" class="form-control" maxlength="30">
          <div class="input-group-append">
            <button type="button" name="load_button" value="Search" class="btn btn-primary" onclick="searchTracks()">Search</button>
          </div>
      </div>
    </div>
  </div>
  <div class="form-group row">
    <div class="col-sm-6">
      <input type="submit" name="load_button" value="Reccomended" class="btn btn-primary">
    </div>
    <div class="col-sm-6">
      <button type="button" id="save-button" onclick="saveTracks()" class="btn btn-danger pull-right">SAVE tracks</button>
    </div>
  </div>
</form>


<div class="container mt-5">
  <div class="row">
    <div class="col-sm-4">
		<table class="table  table-hover" id="recommendedTable">
            <tbody id="tbodyrec">
			<tr>
				<th>Songs for you ... </th>
			</tr>

            </tbody>
        </table>
    </div>
    <div class="col-sm-4">
        <table class="table  table-hover border" id="playListTable" >
            <tbody id="tbodylist">
			<tr>
				<th>Track in </th>
			</tr>
			{% for song in playListTracks %}
			<tr>
                <tr>
				<td class="btn btn-default" data-song-id="{{song[1]}}">{{song[0]}}</td>
				<td class="move-cell"><button type="button" class="btn btn-danger" onclick="removeTrack(this)">Remove</button></td>
				</tr>
			{% endfor %}
		</tbody>
        </table>
    </div>
  </div>


<script>
function removeTrack(pressedRow) {
    /* This method will delete a row */
    console.log("removeTrack: ",pressedRow.parentNode.parentNode);
    pressedRow.parentNode.parentNode.remove();
    }
</script>
<script>
function transferTrack(pressedRow) {
      // Get the clicked row and its first data cell
      const clickedRow = pressedRow.parentNode.parentNode;
      const clickedCell = clickedRow.querySelector('td:first-child');

      // New row with a copy of the first cell of the clicked row
      const playlistTable = document.getElementById('playListTable');
      const playlistTBody = playlistTable.tBodies[0];
      const newRow = playlistTBody.insertRow(1);
      const newCell = newRow.insertCell(0);
      newCell.className = clickedCell.className;
      newCell.setAttribute('data-song-id', clickedCell.getAttribute('data-song-id'));
      newCell.textContent = clickedCell.textContent;

      // new row add a remove button
      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'btn btn-danger';
      removeButton.textContent = 'Remove';
      removeButton.addEventListener('click', function() {
        removeTrack(this);
      });

      const removeCell = newRow.insertCell(1);
      removeCell.classList.add('move-cell');
      removeCell.appendChild(removeButton);
      pressedRow.parentNode.parentNode.remove();
      console.log("table = ",playlistTable);
}
 </script>

<script>
    function get_playlist_ids()
    {
        var tableData=[];
        var table = document.querySelector('#playListTable');
        var rows = table.querySelectorAll('tr');

        for (var i = 0; i < rows.length; i++) {
            var tdElements = rows[i].querySelectorAll('td');
            for (var j = 0; j < tdElements.length; j++) {
                var idValue = tdElements[j].getAttribute('data-song-id');    //('id');
                if (idValue) {
                    console.log(idValue);
                    tableData.push(idValue);
                }
            }
        }
        console.log('tracks',tableData);
        return tableData;
    }
</script>

<script>
    //Get Official Playlist get_official_album
function officialSoundtrack() {
  // Get the ids from the playlist so there is no repeat
  const tableData = get_playlist_ids();
  console.log('officialSoundtrack',tableData);

  fetchAndHandleResponse('/getSongData', {table_data: tableData });

/*
  fetch('/getSongData', {
    method: 'POST',
    body: JSON.stringify({table_data: tableData}),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    const tbody = document.getElementById("tbodyrec");
    tbody.innerHTML = "<tr><th>Official Soundtrack</th></tr>";
    for (var i = 0; i < data.length; i++) {
      var row = tbody.insertRow();
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      cell1.innerHTML = data[i][0];
      cell2.innerHTML = '<button type="button" class="btn btn-danger my-add-button" onclick="transferTrack(this)">Add</button>';
      cell1.setAttribute("class", "btn btn-default");
      cell1.setAttribute("data-song-id", data[i][1]);
    }
  })
  .catch(error => {
    console.error('Error:', error);
  });
*/
}
</script>
<script>
function searchTracks() {
  const tableData = get_playlist_ids();
  const songName = document.getElementById("song-name").value;
  console.log(songName);

  fetchAndHandleResponse('/searchForMatchingTracks', { song_name: songName, table_data: tableData });
}

function fetchAndHandleResponse(url, data) {
  fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    const tbody = document.getElementById("tbodyrec");
    tbody.innerHTML = "<tr><th>Official Soundtrack</th></tr>";
    for (var i = 0; i < data.length; i++) {
      var row = tbody.insertRow();
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      cell1.innerHTML = data[i][0];

      cell2.innerHTML = '<button type="button" class="btn btn-danger my-add-button" onclick="transferTrack(this)">Add</button>';
      cell1.setAttribute("class", "btn btn-default");
      cell1.setAttribute("data-song-id", data[i][1]);
    }
  })
  .catch(error => {
    console.error('Error:', error);
  });
}
</script>
<script>
async function saveTracks() {
  const tableData = get_playlist_ids();
  console.log('Save tracks', tableData);

  const response = await fetch('/update_table', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({table_data: tableData})
  });

  if (response.ok) {
    console.log('Table data was successfully sent to the server');
    alert('Successfully saved to Play List',tableData);
  } else {
    console.error('Network response was not ok');
  }
}

</script>
</div>
</body>

{% endblock %}
